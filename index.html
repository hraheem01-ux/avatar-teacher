<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ø§Ù„Ø°ÙƒÙŠ</title>

  <style>
    :root{
      --bg:#020617;
      --glass: rgba(2,6,23,.62);
      --line: rgba(148,163,184,.22);
      --txt:#f8fafc;
      --muted:#cbd5e1;
      --green:#22c55e;
      --blue:#0ea5e9;
      --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
      height:100vh; overflow:hidden;
    }

    .stage{position:fixed; inset:0; overflow:hidden;}

    /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙˆØ±Ø© */
    #bgImg{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      object-position:center 20%;
      transform:scale(1.02);
      filter:contrast(1.05) saturate(1.05);
    }

    /* ØªØºÙ…ÙŠÙ‚ + ÙÙŠÙ†ÙŠØª */
    .vignette{
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 25%, rgba(0,0,0,.12) 0%, rgba(0,0,0,.55) 55%, rgba(0,0,0,.72) 100%),
        linear-gradient(to bottom, rgba(0,0,0,.10), rgba(0,0,0,.55));
      pointer-events:none;
    }

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    .brand{
      position:absolute; top:16px; left:16px; right:16px;
      width:min(980px,96vw); margin:0 auto;
      background:rgba(2,6,23,.35);
      border:1px solid rgba(148,163,184,.18);
      backdrop-filter:blur(10px);
      border-radius:18px;
      padding:14px 16px;
      text-align:center;
    }
    .brand h1{margin:0;font-size:30px}
    .brand p{margin:6px 0 0;color:var(--muted);font-size:14px}

    /* Ø§Ù„Ù„ÙˆØ­Ø© */
    .panelWrap{
      position:absolute; left:0; right:0; bottom:0;
      padding:16px 16px 18px;
      display:flex; justify-content:center;
    }
    .panel{
      width:min(980px,96vw);
      background:var(--glass);
      border:1px solid var(--line);
      backdrop-filter:blur(12px);
      border-radius:20px;
      padding:14px;
      box-shadow:0 24px 80px rgba(0,0,0,.55);
    }

    .subs{
      width:100%;
      border-radius:14px;
      background:rgba(2,6,23,.35);
      border:1px solid rgba(148,163,184,.16);
      padding:10px 12px;
      text-align:center;
      color:var(--muted);
      margin-bottom:10px;
      min-height:44px;
      display:flex; align-items:center; justify-content:center;
      font-size:14px;
    }

    .chat{
      height:min(28vh,260px);
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.25);
      padding:12px;
      line-height:1.75;
      font-size:15px;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center}
    button{
      border:0; cursor:pointer;
      padding:14px 16px;
      border-radius:999px;
      font-size:16px;
      font-weight:900;
      flex:1;
      min-width:220px;
    }
    #micBtn{background:var(--green);color:#052e16}
    #micBtn.recording{background:var(--red);color:#fff}
    #askBtn{background:var(--blue);color:#e0f2fe}

    .smallrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center}
    select{
      flex:1; min-width:260px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.55);
      color:var(--txt);
      font-size:13px;
    }
    .toggle{
      flex:0; min-width:260px;
      background:rgba(15,23,42,.75);
      color:var(--txt);
      border:1px solid rgba(148,163,184,.25);
      font-weight:900;
    }

    .status{margin-top:10px; text-align:center; color:var(--muted); font-size:13px}

    @media (max-width:560px){
      .brand h1{font-size:24px}
      #bgImg{object-position:center 15%}
      .panel{padding:12px}
    }
  </style>
</head>

<body>
  <div class="stage">
    <!-- âœ… Ø§Ù„Ø®Ù„ÙÙŠØ©: Ø±Ø§Ø¨Ø· iBB Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
    <img id="bgImg" src="https://i.ibb.co/79tBtzg/Avatar.jpg" alt="Avatar">
    <div class="vignette"></div>

    <div class="brand">
      <h1>Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ø§Ù„Ø°ÙƒÙŠ</h1>
      <p>Ø§Ø³Ø£Ù„Ù†ÙŠ ØµÙˆØªÙŠÙ‹Ø§ Ø£Ùˆ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¹Ù† Ø¯Ø±ÙˆØ³Ùƒ</p>
    </div>

    <div class="panelWrap">
      <div class="panel">
        <div id="subs" class="subs">Ø¬Ø§Ù‡Ø² Ù„Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯.</div>

        <div id="chatLog" class="chat">
          <div>ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: Ù…Ø±Ø­Ø¨Ù‹Ø§</div>
          <div>ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: Ø£Ù‡Ù„Ù‹Ø§ Ø¨Ùƒ ÙŠØ§ Ø¨Ø·Ù„ØŒ Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø¯Ø±Ø³.</div>
        </div>

        <div class="row">
          <button id="micBtn">ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«</button>
          <button id="askBtn">âœï¸ Ø§Ø¶ØºØ· Ù„ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„</button>
        </div>

        <div class="smallrow">
          <select id="voiceSelect">
            <option value="ar-SA-HamedNeural">Hamed (Saudi) - Ø°ÙƒØ±</option>
            <option value="ar-SA-ZariyahNeural">Zariyah (Saudi) - Ø£Ù†Ø«Ù‰</option>
          </select>
          <button id="voiceToggle" class="toggle">ğŸ”Š ØµÙˆØª Azure: Ù…ÙØ¹Ù‘Ù„</button>
        </div>

        <div id="status" class="status">Ø§Ù„ØµÙˆØª Ù…Ù† Azure â€” ÙˆØ§Ù„Ø±Ø¯ Ù…Ù† GPT Ø¹Ø¨Ø± Apps Script.</div>
      </div>
    </div>
  </div>

<script>
  // âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Web App Ø­Ù‚Ùƒ (Ù„Ø§ ØªØºÙŠÙ‘Ø±Ù‡)
  const API_BASE = "https://script.google.com/macros/s/AKfycbwDxKqcI5ecojJswXMH6gAT8QaMZj88TO3PKcxNYvCWLIN11Y0tIZLPJ2H7GKzE1ef3/exec";

  const micBtn      = document.getElementById('micBtn');
  const askBtn      = document.getElementById('askBtn');
  const chatLog     = document.getElementById('chatLog');
  const statusEl    = document.getElementById('status');
  const subsEl      = document.getElementById('subs');
  const voiceToggle = document.getElementById('voiceToggle');
  const voiceSelect = document.getElementById('voiceSelect');

  let history = [];
  let voiceEnabled = true;
  let currentAudio = null;
  let isListening = false;

  function addLine(prefix, text){
    const div = document.createElement('div');
    div.textContent = prefix + text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  function setSubs(t){ subsEl.textContent = t || ''; }

  function stopAudio(){
    try{
      if(currentAudio){
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
    }catch(e){}
    currentAudio = null;
  }

  async function apiGet(params){
    const url = API_BASE + (API_BASE.includes('?') ? '&' : '?') + new URLSearchParams(params).toString();
    const res = await fetch(url, { method:'GET' });
    const data = await res.json();
    return data;
  }

  // âœ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Azure (Ù…Ù† Apps Script)
  async function speakAzure(text){
    if(!voiceEnabled) return;
    stopAudio();

    const data = await apiGet({ action:'tts', text, voice: voiceSelect.value });
    if(!data || !data.audioDataUri){
      statusEl.textContent = "âš ï¸ Ù„Ù… ÙŠØµÙ„ Ù…Ù„Ù ØµÙˆØª Ù…Ù† Azure.";
      return;
    }
    currentAudio = new Audio(data.audioDataUri);
    currentAudio.onended = ()=> statusEl.textContent = "Ø¬Ø§Ù‡Ø².";
    currentAudio.onerror = ()=> statusEl.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.";
    try{
      await currentAudio.play();
      statusEl.textContent = "ğŸ”Š ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...";
    }catch(e){
      statusEl.textContent = "âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â€” Ø§Ø¶ØºØ· Ø£ÙŠ Ø²Ø± Ø«Ù… Ø¬Ø±Ù‘Ø¨.";
    }
  }

  // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¥Ù„Ù‰ GPT (Apps Script) Ø«Ù… ØªØ´ØºÙŠÙ„ Azure Ù„Ù„Ø±Ø¯
  async function ask(question){
    setSubs("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...");
    statusEl.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ GPT...";
    const h = JSON.stringify(history);

    const data = await apiGet({ action:'ask', q: question, h });
    const reply = (data && data.reply) ? data.reply : "Ù„Ù… ÙŠØµÙ„ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.";

    addLine("ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: ", reply);

    history.push({role:'user', content: question});
    history.push({role:'assistant', content: reply});

    setSubs("ØªÙ… Ø§Ù„Ø±Ø¯ âœ…");
    await speakAzure(reply);
  }

  // Ø²Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
  askBtn.addEventListener('click', async ()=>{
    const q = prompt("Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ:");
    if(!q) return;
    addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", q);
    await ask(q);
  });

  // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ØµÙˆØª Azure
  voiceToggle.addEventListener('click', ()=>{
    voiceEnabled = !voiceEnabled;
    voiceToggle.textContent = voiceEnabled ? "ğŸ”Š ØµÙˆØª Azure: Ù…ÙØ¹Ù‘Ù„" : "ğŸ”ˆ ØµÙˆØª Azure: Ù…ØªÙˆÙ‚Ù";
    if(!voiceEnabled) stopAudio();
  });

  // Ø§Ù„Ù…Ø§ÙŠÙƒ (SpeechRecognition)
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  if(!SR){
    micBtn.disabled = true;
    micBtn.style.opacity = .6;
    statusEl.textContent = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø§Ø³ØªØ®Ø¯Ù… Chrome.";
  } else {
    recognition = new SR();
    recognition.lang = 'ar-SA';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = ()=>{
      isListening = true;
      micBtn.classList.add('recording');
      micBtn.textContent = "ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù";
      setSubs("ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...");
      statusEl.textContent = "ğŸ™ï¸ ÙŠØ³ØªÙ…Ø¹...";
    };

    recognition.onerror = (e)=>{
      isListening = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = "ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«";
      setSubs("Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      statusEl.textContent = "âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒ: " + (e.error || '');
    };

    recognition.onend = ()=>{
      isListening = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = "ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«";
      if(subsEl.textContent === "ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...") setSubs("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹.");
    };

    recognition.onresult = async (event)=>{
      const transcript = event.results[0][0].transcript;
      addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", transcript);
      await ask(transcript);
    };

    micBtn.addEventListener('click', ()=>{
      if(!isListening){
        try{ recognition.start(); } catch(e){}
      } else {
        recognition.stop();
      }
    });
  }
</script>
</body>
</html>

