<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</title>
  <style>
    :root{--bg:#020617;--glass:rgba(2,6,23,.55);--line:rgba(148,163,184,.25);--txt:#f8fafc;--muted:#cbd5e1;--green:#22c55e;--blue:#0ea5e9;--red:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;height:100vh;overflow:hidden}
    .stage{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(1200px 700px at 50% 30%, #0b122a 0%, #020617 60%)}

    /* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */
    video#avatarVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#020617}

    /* ØµÙˆØ±Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
    img#avatarPoster{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; background:#020617;
      filter:saturate(1.05) contrast(1.05);
      transform:scale(1.10); /* ØªÙƒØ¨ÙŠØ± Ø®ÙÙŠÙ Ù„Ù„ÙˆØ¬Ù‡ */
    }

    .ui{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:flex-end;padding:20px;gap:14px}
    .brand{position:absolute;top:18px;right:18px;left:18px;width:min(980px,96vw);margin:0 auto;background:var(--glass);border:1px solid var(--line);backdrop-filter:blur(10px);border-radius:18px;padding:14px 16px;text-align:center}
    .brand h1{margin:0;font-size:28px}
    .brand p{margin:6px 0 0;color:var(--muted);font-size:14px}
    .subs{width:min(980px,96vw);margin:0 auto;padding:10px 14px;border-radius:14px;background:rgba(2,6,23,.45);border:1px solid rgba(148,163,184,.18);text-align:center;min-height:48px;display:flex;align-items:center;justify-content:center}
    .panel{width:min(980px,96vw);margin:0 auto;background:var(--glass);border:1px solid var(--line);backdrop-filter:blur(10px);border-radius:18px;padding:14px}
    .chat{height:min(30vh,260px);overflow:auto;border-radius:14px;border:1px solid rgba(148,163,184,.18);padding:12px;background:rgba(2,6,23,.35);line-height:1.75;font-size:15px}
    .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center}
    button{border:0;cursor:pointer;padding:14px 16px;border-radius:999px;font-size:16px;font-weight:800;flex:1;min-width:220px}
    #micBtn{background:var(--green);color:#052e16}
    #micBtn.recording{background:var(--red);color:#fff}
    #askBtn{background:var(--blue);color:#e0f2fe}
    .smallrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center}
    select{flex:1;min-width:260px;padding:10px 12px;border-radius:999px;border:1px solid rgba(148,163,184,.25);background:rgba(2,6,23,.55);color:var(--txt);font-size:13px}
    .toggle{flex:0;min-width:220px;background:rgba(15,23,42,.75);color:var(--txt);border:1px solid rgba(148,163,184,.25);font-weight:800}
    .status{margin-top:10px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="stage">

    <!-- ØµÙˆØ±Ø© Ø«Ø§Ø¨ØªØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
    <img id="avatarPoster" alt="Avatar" />

    <!-- ÙÙŠØ¯ÙŠÙˆ D-ID -->
    <video id="avatarVideo" playsinline></video>

    <div class="brand">
      <h1>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</h1>
      <p>Ø³Ø¤Ø§Ù„ ØµÙˆØªÙŠ/ÙƒØªØ§Ø¨ÙŠ â†’ Ø±Ø¯ GPT â†’ ÙÙŠØ¯ÙŠÙˆ D-ID (Ø´ÙØ§Ù‡ ØªØªØ­Ø±Ùƒ)</p>
    </div>

    <div class="ui">
      <div id="subs" class="subs">Ø¬Ø§Ù‡Ø² Ù„Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯.</div>

      <div class="panel">
        <div id="chatLog" class="chat">
          <div>ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: Ù…Ø±Ø­Ø¨Ù‹Ø§</div>
          <div>ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: Ø£Ù‡Ù„Ù‹Ø§ Ø¨ÙƒØŒ Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ.</div>
        </div>

        <div class="row">
          <button id="micBtn">ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«</button>
          <button id="askBtn">âœï¸ Ø§Ø¶ØºØ· Ù„ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„</button>
        </div>

        <div class="smallrow">
          <select id="voiceSelect">
            <option value="ar-SA-HamedNeural">Hamed (Saudi) - Ø°ÙƒØ±</option>
            <option value="ar-SA-ZariyahNeural">Zariyah (Saudi) - Ø£Ù†Ø«Ù‰</option>
          </select>
          <button id="voiceToggle" class="toggle">ğŸ”Š ØµÙˆØª Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù…ÙØ¹Ù‘Ù„</button>
        </div>

        <div id="status" class="status">Ø¥Ø°Ø§ ØªØ¹Ø°Ø± D-ID Ø³ÙŠØ´ØªØºÙ„ Azure ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
      </div>
    </div>
  </div>

<script>
  // 1) Ø±Ø§Ø¨Ø· Web App Ø­Ù‚Ùƒ
  const API_BASE = "https://script.google.com/macros/s/AKfycbwDxKqcI5ecojJswXMH6gAT8QaMZj88TO3PKcxNYvCWLIN11Y0tIZLPJ2H7GKzE1ef3/exec";

  // 2) Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Public)
  // Ù†ÙØ³ File ID Ø­Ù‚ ØµÙˆØ±ØªÙƒ:
  const AVATAR_URL = "https://drive.google.com/file/d/1PPnEInmBsKJvxHZC6sqajl6zANW201Tz/view";

  const micBtn = document.getElementById('micBtn');
  const askBtn = document.getElementById('askBtn');
  const chatLog = document.getElementById('chatLog');
  const statusEl = document.getElementById('status');
  const subsEl = document.getElementById('subs');
  const voiceToggle = document.getElementById('voiceToggle');
  const voiceSelect = document.getElementById('voiceSelect');
  const videoEl = document.getElementById('avatarVideo');
  const posterEl = document.getElementById('avatarPoster');

  posterEl.src = AVATAR_URL;  // Ø§Ù„Ø¢Ù† Ø§Ù„ØµÙˆØ±Ø© ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹

  let history = [];
  let voiceEnabled = true;
  let currentAudio = null;
  let isListening = false;

  function addLine(prefix, text){
    const div = document.createElement('div');
    div.textContent = prefix + text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }
  function setSubs(t){ subsEl.textContent = t || ''; }
  function stopAudio(){ try{ if(currentAudio){currentAudio.pause();currentAudio.currentTime=0;} }catch(e){} currentAudio=null; }

  async function apiGet(params){
    const url = API_BASE + (API_BASE.includes('?') ? '&' : '?') + new URLSearchParams(params).toString();
    const res = await fetch(url, { method:'GET' });
    const data = await res.json();
    if(data && data.ok === false && data.error) throw new Error(data.error);
    return data;
  }

  async function speakAzure(text){
    if(!voiceEnabled) return;
    stopAudio();
    const data = await apiGet({ action:'tts', text, voice: voiceSelect.value });
    if(!data.audioDataUri) return;
    currentAudio = new Audio(data.audioDataUri);
    currentAudio.play().catch(()=>{});
  }

  async function playDid(text){
    setSubs(text);
    statusEl.textContent = "ğŸ¬ Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ D-ID...";
    try{
      const data = await apiGet({ action:'did', text });
      if(!data.videoUrl) throw new Error("No videoUrl from D-ID");

      // Ø´ØºÙ‘Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ®ÙÙ‘Ù Ø¸Ù‡ÙˆØ± Ø§Ù„ØµÙˆØ±Ø©
      videoEl.src = data.videoUrl;
      videoEl.muted = false;
      await videoEl.play();

      posterEl.style.opacity = "0.15";  // ØªØ¨Ù‚Ù‰ ØµÙˆØ±Ø© Ø®ÙÙŠÙØ© ÙƒØ®Ù„ÙÙŠØ© Ù„Ùˆ ØªØ­Ø¨
      statusEl.textContent = "âœ… ÙÙŠØ¯ÙŠÙˆ D-ID ÙŠØ¹Ù…Ù„.";

    }catch(e){
      console.error(e);
      statusEl.textContent = "âš ï¸ ØªØ¹Ø°Ø± ÙÙŠØ¯ÙŠÙˆ D-ID â€” ØªØ´ØºÙŠÙ„ Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ.";
      posterEl.style.opacity = "1";
      speakAzure(text);
    }
  }

  async function ask(question){
    setSubs("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...");
    statusEl.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
    const h = JSON.stringify(history);
    const data = await apiGet({ action:'ask', q: question, h });
    const reply = data.reply || "Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø±Ø¯.";
    addLine("ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: ", reply);
    history.push({role:'user', content: question});
    history.push({role:'assistant', content: reply});
    await playDid(data.clean || reply);
  }

  askBtn.addEventListener('click', async ()=>{
    const q = prompt("Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ:");
    if(!q) return;
    addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", q);
    await ask(q);
  });

  voiceToggle.addEventListener('click', ()=>{
    voiceEnabled = !voiceEnabled;
    voiceToggle.textContent = voiceEnabled ? "ğŸ”Š ØµÙˆØª Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù…ÙØ¹Ù‘Ù„" : "ğŸ”ˆ ØµÙˆØª Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù…ØªÙˆÙ‚Ù";
    if(!voiceEnabled) stopAudio();
  });

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  if(!SpeechRecognition){
    micBtn.disabled = true; micBtn.style.opacity=.6;
    statusEl.textContent = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø§Ø³ØªØ®Ø¯Ù… Chrome.";
  }else{
    recognition = new SpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = ()=>{
      isListening=true;
      micBtn.classList.add('recording');
      micBtn.textContent="ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù";
      setSubs("ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...");
      statusEl.textContent="ğŸ™ï¸ ÙŠØ³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†...";
    };
    recognition.onerror = (e)=>{
      isListening=false;
      micBtn.classList.remove('recording');
      micBtn.textContent="ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«";
      statusEl.textContent="âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒ: "+e.error;
      setSubs("Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    };
    recognition.onend = ()=>{
      isListening=false;
      micBtn.classList.remove('recording');
      micBtn.textContent="ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«";
    };
    recognition.onresult = async (event)=>{
      const transcript = event.results[0][0].transcript;
      addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", transcript);
      await ask(transcript);
    };
    micBtn.addEventListener('click', ()=>{
      if(!isListening) recognition.start();
      else recognition.stop();
    });
  }
</script>
</body>
</html>
