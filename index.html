<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ø§Ù„Ø°ÙƒÙŠ</title>
  <style>
    :root{
      --bg:#020617;
      --glass: rgba(2,6,23,.55);
      --line: rgba(148,163,184,.25);
      --txt:#f8fafc;
      --muted:#cbd5e1;
      --green:#22c55e;
      --blue:#0ea5e9;
      --red:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      height:100vh; overflow:hidden;
    }

    /* ===== FULLSCREEN AVATAR STAGE ===== */
    .stage{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 700px at 50% 30%, #0b122a 0%, #020617 55%, #020617 100%);
    }

    video#avatarVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      filter: contrast(1.02) saturate(1.02);
      background:#020617;
    }

    /* fallback image while no video */
    .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(900px 600px at 50% 30%, #0b122a 0%, #020617 70%);
    }
    .fallback img{
      width:min(260px,40vw);
      height:min(260px,40vw);
      border-radius:50%;
      object-fit:cover;
      border:4px solid rgba(255,255,255,.15);
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
    }

    /* ===== UI OVERLAY ===== */
    .ui{
      position:absolute; inset:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:20px;
      gap:14px;
      pointer-events:none;
    }

    .topbar{
      position:absolute;
      top:18px; right:18px; left:18px;
      display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }
    .brand{
      width:min(980px,96vw);
      background: var(--glass);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      border-radius:18px;
      padding:14px 16px;
      text-align:center;
    }
    .brand h1{
      margin:0;
      font-size:28px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
    }

    .panel{
      width:min(980px,96vw);
      margin:0 auto;
      background: var(--glass);
      border:1px solid var(--line);
      backdrop-filter: blur(10px);
      border-radius:18px;
      padding:14px;
      pointer-events:auto;
    }

    .chat{
      height:min(30vh,260px);
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      padding:12px;
      background: rgba(2,6,23,.35);
      line-height:1.75;
      font-size:15px;
    }
    .row{
      display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:0; cursor:pointer;
      padding:14px 16px;
      border-radius:999px;
      font-size:16px;
      font-weight:700;
      flex:1;
      min-width: 220px;
    }
    #micBtn{background:var(--green); color:#052e16;}
    #micBtn.recording{background:var(--red); color:#fff;}
    #askBtn{background:var(--blue); color:#e0f2fe;}

    .smallrow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    select{
      flex:1;
      min-width:260px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.55);
      color:var(--txt);
      font-size:13px;
    }
    .toggle{
      flex:0;
      min-width:220px;
      background: rgba(15,23,42,.75);
      color:var(--txt);
      border:1px solid rgba(148,163,184,.25);
      font-weight:700;
    }
    .status{
      margin-top:10px;
      text-align:center;
      color:var(--muted);
      font-size:13px;
    }

    /* subtitles */
    .subs{
      width:min(980px,96vw);
      margin:0 auto;
      padding:10px 14px;
      border-radius:14px;
      background: rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.18);
      color:#fff;
      font-size:15px;
      line-height:1.6;
      pointer-events:none;
      text-align:center;
      min-height:48px;
      display:flex; align-items:center; justify-content:center;
    }
  </style>
</head>
<body>

  <div class="stage">

    <video id="avatarVideo" playsinline muted></video>

    <div id="fallback" class="fallback">
      <img src="<?!= getAvatarDataUri(); ?>" alt="Avatar" />
    </div>

    <div class="topbar">
      <div class="brand">
        <h1>Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p>Ø§Ø³Ø£Ù„Ù†ÙŠ ØµÙˆØªÙŠÙ‹Ø§ Ø£Ùˆ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© â€” ÙˆØ³Ø£Ø¬ÙŠØ¨Ùƒ Ù…Ø¹ ÙÙŠØ¯ÙŠÙˆ Ù…ØªØ²Ø§Ù…Ù† (ØªØ­Ø±ÙŠÙƒ Ø´ÙØ§Ù‡) Ø¹Ø¨Ø± D-ID.</p>
      </div>
    </div>

    <div class="ui">
      <div id="subs" class="subs">Ø¬Ø§Ù‡Ø² Ù„Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯.</div>

      <div class="panel">
        <div id="chatLog" class="chat">
          <div>ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: Ù…Ø±Ø­Ø¨Ù‹Ø§</div>
          <div>ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: Ø£Ù‡Ù„Ù‹Ø§ Ø¨ÙƒØŒ Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ.</div>
        </div>

        <div class="row">
          <button id="micBtn">ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«</button>
          <button id="askBtn">âœï¸ Ø§Ø¶ØºØ· Ù„ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„</button>
        </div>

        <div class="smallrow">
          <select id="voiceSelect" title="ØµÙˆØª Azure Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ">
            <option value="ar-SA-HamedNeural">Hamed (Saudi) - Ø°ÙƒØ±</option>
            <option value="ar-SA-ZariyahNeural">Zariyah (Saudi) - Ø£Ù†Ø«Ù‰</option>
          </select>

          <button id="voiceToggle" class="toggle">ğŸ”Š Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Azure): Ù…ÙØ¹Ù‘Ù„</button>
        </div>

        <div id="status" class="status">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø±Ùƒ Ø§Ù„Ø´ÙØ§Ù‡. Azure ØµÙˆØª Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.</div>
      </div>
    </div>

  </div>

<script>
  const micBtn      = document.getElementById('micBtn');
  const askBtn      = document.getElementById('askBtn');
  const chatLog     = document.getElementById('chatLog');
  const statusEl    = document.getElementById('status');
  const subsEl      = document.getElementById('subs');
  const voiceToggle = document.getElementById('voiceToggle');
  const voiceSelect = document.getElementById('voiceSelect');

  const videoEl     = document.getElementById('avatarVideo');
  const fallbackEl  = document.getElementById('fallback');

  let history = [];
  let voiceEnabled = true;
  let currentAudio = null;
  let isListening = false;

  function addLine(prefix, text){
    const div = document.createElement('div');
    div.textContent = prefix + text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function setSubs(text){
    subsEl.textContent = text || '';
  }

  function stopAudio(){
    try{
      if(currentAudio){ currentAudio.pause(); currentAudio.currentTime = 0; }
    }catch(e){}
    currentAudio = null;
  }

  function cleanForSpeech(text){
    if(!text) return '';
    return String(text)
      .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g, '') // remove tashkeel
      .replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}]/gu,'')
      .replace(/[â€¢â—â—†â– â–¶ï¸âœ…âŒâ­]/g,'')
      .replace(/\s+/g,' ')
      .trim();
  }

  // ===== Azure fallback TTS (Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Ù†Ø§Ù‡) =====
  function speakAzure(text){
    if(!voiceEnabled) return;
    const clean = cleanForSpeech(text);
    if(!clean) return;

    stopAudio();
    const selectedVoice = voiceSelect?.value || "";

    google.script.run
      .withSuccessHandler((audioUrl)=>{
        if(!audioUrl) return;
        currentAudio = new Audio(audioUrl);
        currentAudio.play().catch(()=>{});
      })
      .azureTTS(clean, selectedVoice);
  }

  // ===== D-ID Video (Lip Sync) =====
  function playDidVideoFor(text){
    const clean = cleanForSpeech(text);
    if(!clean) return;

    setSubs(clean);
    statusEl.textContent = "ğŸ¬ Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø¹Ù„Ù… (D-ID)...";

    google.script.run
      .withSuccessHandler((videoUrl)=>{
        if(!videoUrl){
          statusEl.textContent = "âš ï¸ Ù„Ù… ÙŠØµÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† D-ID â€” Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.";
          speakAzure(clean);
          return;
        }

        // show video, hide fallback image
        fallbackEl.style.display = "none";
        videoEl.muted = false;

        videoEl.src = videoUrl;
        videoEl.onloadeddata = ()=>{
          statusEl.textContent = "âœ… ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†.";
          videoEl.play().catch(()=>{
            // Ø¥Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            statusEl.textContent = "Ø§Ø¶ØºØ· Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¨Ø§Ù„Ø³Ø§Ø­Ø© Ø«Ù… Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.";
          });
        };

        videoEl.onerror = ()=>{
          statusEl.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ D-ID â€” Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.";
          speakAzure(clean);
        };
      })
      .withFailureHandler((err)=>{
        console.error(err);
        statusEl.textContent = "âš ï¸ ÙØ´Ù„ D-ID â€” Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.";
        speakAzure(clean);
      })
      .didTalk(clean);
  }

  function sendToTeacher(questionText){
    setSubs("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...");
    statusEl.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¤Ø§Ù„Ùƒ Ù„Ù„Ù…Ø¹Ù„Ù…...";

    google.script.run
      .withSuccessHandler((reply)=>{
        if(!reply) reply = "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¢Ù†.";
        addLine("ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: ", reply);
        history.push({role:'user', content: questionText});
        history.push({role:'assistant', content: reply});

        // Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ D-ID (ÙŠØ­Ø±Ùƒ Ø§Ù„Ø´ÙØ§Ù‡)
        playDidVideoFor(reply);
      })
      .withFailureHandler((err)=>{
        console.error(err);
        addLine("ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: ", "ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        setSubs("Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„.");
        statusEl.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.";
      })
      .processQuestion(questionText, JSON.stringify(history));
  }

  askBtn.addEventListener('click', ()=>{
    const q = prompt("Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ:");
    if(!q) return;
    addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", q);
    sendToTeacher(q);
  });

  voiceToggle.addEventListener('click', ()=>{
    voiceEnabled = !voiceEnabled;
    voiceToggle.textContent = voiceEnabled ? "ğŸ”Š Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Azure): Ù…ÙØ¹Ù‘Ù„" : "ğŸ”ˆ Ø§Ù„ØµÙˆØª Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Azure): Ù…ØªÙˆÙ‚Ù";
    if(!voiceEnabled) stopAudio();
  });

  // ===== Mic (SpeechRecognition) =====
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;

  if(!SpeechRecognition){
    micBtn.disabled = true;
    micBtn.style.opacity = .6;
    statusEl.textContent = "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø§Ø³ØªØ®Ø¯Ù… Chrome.";
  } else {
    recognition = new SpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = ()=>{
      isListening = true;
      micBtn.classList.add('recording');
      micBtn.textContent = "ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù";
      setSubs("ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...");
      statusEl.textContent = "ğŸ™ï¸ ÙŠØ³ØªÙ…Ø¹ Ø§Ù„Ø¢Ù†...";
    };

    recognition.onerror = (e)=>{
      isListening = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = "ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«";
      statusEl.textContent = "âš ï¸ Ø®Ø·Ø£ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒ: " + e.error;
      setSubs("Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
    };

    recognition.onend = ()=>{
      isListening = false;
      micBtn.classList.remove('recording');
      micBtn.textContent = "ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«";
    };

    recognition.onresult = (event)=>{
      const transcript = event.results[0][0].transcript;
      addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", transcript);
      sendToTeacher(transcript);
    };

    micBtn.addEventListener('click', ()=>{
      if(!recognition) return;
      if(!isListening) recognition.start();
      else recognition.stop();
    });
  }
</script>
</body>
</html>
