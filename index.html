<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ</title>

<style>
:root{
  --bg:#020617;
  --glass:rgba(2,6,23,.65);
  --line:rgba(148,163,184,.25);
  --txt:#f8fafc;
  --muted:#cbd5e1;
  --green:#22c55e;
  --blue:#0ea5e9;
  --red:#ef4444;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  color:var(--txt);
  font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial,sans-serif;
  height:100vh;
  overflow:hidden;
}

/* Ø§Ù„Ù…Ø³Ø±Ø­ */
.stage{
  position:fixed;
  inset:0;
  background:#000;
}

/* Ø§Ù„Ø®Ù„ÙÙŠØ© */
img#avatarPoster,
video#avatarVideo{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

/* âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ */
.brand{
  display:none !important;
}

/* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
.ui{
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  padding:20px;
  z-index:5;
}

/* âœ… Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„Ø³ÙÙ„ÙŠ (60%) */
.panel{
  width:60% !important;
  max-width:60% !important;
  margin:0 auto !important;
  background:var(--glass);
  border:1px solid var(--line);
  backdrop-filter:blur(10px);
  border-radius:18px;
  padding:14px;
}


/* Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
.chat{
  height:120px;
  overflow-y:auto;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.18);
  padding:10px;
  background:rgba(2,6,23,.35);
  font-size:14px;
  line-height:1.6;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.row{
  display:flex;
  gap:12px;
  margin-top:10px;
}

button{
  border:0;
  cursor:pointer;
  padding:14px;
  border-radius:999px;
  font-size:15px;
  font-weight:800;
  flex:1;
}

#micBtn{background:var(--green);color:#052e16}
#micBtn.recording{background:var(--red);color:#fff}
#askBtn{background:var(--blue);color:#e0f2fe}

/* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
.smallrow{
  display:flex;
  gap:10px;
  margin-top:10px;
  align-items:center;
}

select{
  flex:1;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(2,6,23,.55);
  color:var(--txt);
  font-size:13px;
}

.toggle{
  background:rgba(15,23,42,.75);
  color:var(--txt);
  border:1px solid rgba(148,163,184,.25);
  font-weight:800;
  padding:10px 14px;
}

.status{
  margin-top:6px;
  text-align:center;
  color:var(--muted);
  font-size:12px;
}

/* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
@media (max-width:768px){
  .panel{
    width:95vw;
  }
}
</style>
</head>

<body>
<div class="stage">

  <!-- ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© -->
  <img id="avatarPoster" alt="Avatar" />

  <!-- ÙÙŠØ¯ÙŠÙˆ D-ID -->
  <video id="avatarVideo" playsinline></video>

  <div class="ui">
    <div id="subs" class="subs">Ø¬Ø§Ù‡Ø² Ù„Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯.</div>

    <div class="panel">
      <div id="chatLog" class="chat">
        <div>ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: Ù…Ø±Ø­Ø¨Ù‹Ø§</div>
        <div>ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: Ø£Ù‡Ù„Ù‹Ø§ Ø¨ÙƒØŒ Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ.</div>
      </div>

      <div class="row">
        <button id="micBtn">ğŸ™ï¸ Ø§Ø¶ØºØ· ÙˆØªØ­Ø¯Ù‘Ø«</button>
        <button id="askBtn">âœï¸ Ø§Ø¶ØºØ· Ù„ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„</button>
      </div>

      <div class="smallrow">
        <select id="voiceSelect">
          <option value="ar-SA-HamedNeural">Hamed (Saudi) - Ø°ÙƒØ±</option>
          <option value="ar-SA-ZariyahNeural">Zariyah (Saudi) - Ø£Ù†Ø«Ù‰</option>
        </select>
        <button id="voiceToggle" class="toggle">ğŸ”Š ØµÙˆØª Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù…ÙØ¹Ù‘Ù„</button>
      </div>

      <div id="status" class="status">
        Ø¥Ø°Ø§ ØªØ¹Ø°Ø± D-ID Ø³ÙŠØ´ØªØºÙ„ Azure ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
      </div>
    </div>
  </div>
</div>

<script>
/* ======= âš ï¸ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ======= */

// 1) Ø±Ø§Ø¨Ø· Web App Ø­Ù‚Ùƒ
const API_BASE = "https://script.google.com/macros/s/AKfycbwDxKqcI5ecojJswXMH6gAT8QaMZj88TO3PKcxNYvCWLIN11Y0tIZLPJ2H7GKzE1ef3/exec";

// 2) Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
const AVATAR_URL = "https://i.ibb.co/79tBtzg/Avatar.jpg";

const micBtn = document.getElementById('micBtn');
const askBtn = document.getElementById('askBtn');
const chatLog = document.getElementById('chatLog');
const statusEl = document.getElementById('status');
const subsEl = document.getElementById('subs');
const voiceToggle = document.getElementById('voiceToggle');
const voiceSelect = document.getElementById('voiceSelect');
const videoEl = document.getElementById('avatarVideo');
const posterEl = document.getElementById('avatarPoster');

posterEl.src = AVATAR_URL;

let history = [];
let voiceEnabled = true;
let currentAudio = null;
let isListening = false;

function addLine(prefix, text){
  const div = document.createElement('div');
  div.textContent = prefix + text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

function setSubs(t){ subsEl.textContent = t || ''; }

function stopAudio(){
  try{ if(currentAudio){currentAudio.pause();currentAudio.currentTime=0;} }catch(e){}
  currentAudio=null;
}

async function apiGet(params){
  const url = API_BASE + (API_BASE.includes('?') ? '&' : '?') + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET' });
  return await res.json();
}

async function speakAzure(text){
  if(!voiceEnabled) return;
  stopAudio();
  const data = await apiGet({ action:'tts', text, voice: voiceSelect.value });
  if(!data.audioDataUri) return;
  currentAudio = new Audio(data.audioDataUri);
  currentAudio.play().catch(()=>{});
}

async function playDid(text){
  setSubs(text);
  statusEl.textContent = "ğŸ¬ Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ D-ID...";
  try{
    const data = await apiGet({ action:'did', text });
    videoEl.src = data.videoUrl;
    await videoEl.play();
    posterEl.style.opacity="0.15";
  }catch(e){
    posterEl.style.opacity="1";
    speakAzure(text);
  }
}

async function ask(question){
  setSubs("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...");
  const data = await apiGet({ action:'ask', q: question, h: JSON.stringify(history) });
  addLine("ğŸ¤– Ø§Ù„Ù…Ø¹Ù„Ù…: ", data.reply);
  history.push({role:'user',content:question},{role:'assistant',content:data.reply});
  await playDid(data.clean || data.reply);
}

askBtn.onclick = async ()=>{
  const q = prompt("Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ:");
  if(q){ addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ", q); await ask(q); }
};

voiceToggle.onclick = ()=>{
  voiceEnabled=!voiceEnabled;
  voiceToggle.textContent = voiceEnabled ? "ğŸ”Š ØµÙˆØª Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù…ÙØ¹Ù‘Ù„" : "ğŸ”ˆ ØµÙˆØª Azure Ø§Ø­ØªÙŠØ§Ø·ÙŠ: Ù…ØªÙˆÙ‚Ù";
};

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if(SpeechRecognition){
  const r = new SpeechRecognition();
  r.lang='ar-SA';
  r.onresult=async e=>{
    const t=e.results[0][0].transcript;
    addLine("ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨: ",t);
    await ask(t);
  };
  micBtn.onclick=()=>r.start();
}
</script>
</body>
</html>


